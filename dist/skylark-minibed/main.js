/**
 * skylark-minibed - A version of minibed.js( html/css/js playground) that ported to running on skylarkjs.
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-minibed/
 * @license MIT
 */
define(["skylark-langx/skylark","skylark-codemirror/CodeMirror","./utils","./api","skylark-codemirror/mode/javascript/javascript","skylark-codemirror/mode/htmlmixed/htmlmixed","skylark-codemirror/mode/jsx/jsx","skylark-codemirror/mode/xml/xml","skylark-codemirror/mode/css/css","skylark-codemirror/addon/scroll/simplescrollbars","skylark-codemirror/addon/edit/matchbrackets","skylark-codemirror/addon/edit/closetag","skylark-codemirror/addon/edit/closebrackets"],function(e,t,i,s){return e.attach("intg.Minibed",class{constructor(e={}){return this.options=i.deepExtend({},s.Defaults,e),this.id=this.options.id||i.generateID("bed"),this.liveTimeout=-1,this.isLive=!1,this.heightSetted=!1,this.resizer=null,this.loading=null,this.wrapper=null,this.container=null,this.liveButton=null,this.has={html:!1,css:!1,js:!1},Object.keys(this.options.files).forEach(e=>{if(this.options.files.hasOwnProperty(e))for(let t=0;t<this.options.files[e].length;t++){const r=i.getExtension(this.options.files[e][t]);i.inArray(r,s.FileTypes.html)?this.has.html=!0:i.inArray(r,s.FileTypes.js)?this.has.js=!0:i.inArray(r,s.FileTypes.css)&&(this.has.css=!0)}}),this}show(){return s.build(this),this.container.appendChild(this.wrapper),this.loading=this.container.querySelector(".minibed_loading"),this.bindEvents(),this.initEditor(),this}bindEvents(){const e=this;this.wrapper.querySelectorAll(".minibed_tab").forEach(t=>{i.addListener(t,"click",s=>{i.stopPropagation(s),i.hasClass(t,"minibed_active")||(i.removeClass(e.wrapper.querySelector(".minibed_active"),"minibed_active"),i.addClass(t,"minibed_active")),i.removeClass(e.wrapper.querySelector(".minibed_active_tab"),"minibed_active_tab"),i.removeClass(e.wrapper.querySelector('.minibed_tab_content[data-lang="'+t.getAttribute("data-lang")+'"]'),"minibed_selected_content"),i.addClass(e.wrapper.querySelector('.minibed_tab_content[data-file="'+t.querySelector(".minibed_tabs_current").getAttribute("data-current")+'"]'),"minibed_active_tab minibed_selected_content"),e.initEditor()})}),this.liveButton=this.wrapper.querySelector(".minibed_tab_result"),i.addListener(this.liveButton,"click",()=>{this.liveToggle()}),i.addListener(this.liveButton.querySelector("label"),"click",e=>(e.preventDefault(),!1)),this.wrapper.querySelectorAll(".minibed_dropdown_item").forEach(e=>{i.addListener(e,"click",t=>{if(i.stopPropagation(t),!i.hasClass(e,"minibed_selected_tab")){i.removeClass(e.parentNode.querySelector(".minibed_selected_tab"),"minibed_selected_tab"),i.addClass(e,"minibed_selected_tab");const t=e.parentNode.parentNode.querySelector(".minibed_tabs_current");t.setAttribute("data-current",e.getAttribute("data-file")),t.click()}})})}liveToggle(){i.hasClass(this.liveButton,"mb_live_active")?(i.removeClass(this.liveButton,"mb_live_active"),i.removeClass(this.tabContents,"minibed_live"),this.liveButton.querySelector("#minibed_checkbox-result").removeAttribute("checked"),this.isLive=!1):(i.addClass(this.liveButton,"mb_live_active"),i.addClass(this.tabContents,"minibed_live"),this.liveButton.querySelector("#minibed_checkbox-result").setAttribute("checked","checked"),this.isLive=!0,this.run()),setTimeout(()=>{this.activeEditor.refresh()},10)}importCSS(){let e=this.container.querySelector('.minibed_selected_content[data-lang="css"]');return e?`<style type="text/css">${e.innerHTML}</style>`:""}importHTML(){let e=this.container.querySelector('.minibed_selected_content[data-lang="htmlmixed"]');return e?i.fixHTML(e.value):""}importJS(){let e=this.container.querySelector('.minibed_selected_content[data-lang="javascript"]');return e?`<script type="text/javascript">${e.value}<\/script>`:""}importJSError(){return`<script type="text/javascript">window.onerror = function(msg, source, lineno, colno, error) {\n        console.log(msg, source, lineno, colno, error)\n        parent.document.querySelector('.minibed_bed#${this.id} .minibed_result_frame').style.borderBottomColor = '#F44336';\n      }<\/script>`}importBaseCSS(){return"none"!==this.options.settings.css.base?`<link rel="stylesheet prefetch" href="${s.Includes[this.options.settings.css.base]}"/>`:""}importExternalCSS(){let e="";return this.options.external.css.length>0&&this.options.external.css.forEach(t=>{e+=`<link rel="stylesheet prefetch" href="${t}"/>`}),e}importExternalJS(){let e="";return this.options.external.js.length>0&&this.options.external.js.forEach(t=>{e+=`<script src="${t}" type="text/javascript"><\/script>\n\n\n`}),e}run(){if(this.isLive){i.remove(this.container.querySelector("iframe.minibed_result_frame"));const e=new i.CreateDOM("iframe.minibed_result_frame").setAttr("src","about:blank").setAttr("name",this.id);this.tabContents.appendChild(e.el);const t=`<!DOCTYPE html>\n          <html lang="en">\n          <head>\n            <meta charset="UTF-8">\n            <title>minibed <3</title>\n            ${this.importBaseCSS()}\n            ${this.importExternalCSS()}\n            ${this.importCSS()}\n          </head>\n          <body>\n            ${this.importHTML()}\n            ${this.importJSError()}\n            ${this.importExternalJS()}\n            ${this.importJS()}\n          </body>\n          </html>`,s=window.frames[this.id].document;s.open(),s.write(t),s.close()}}initCodeMirror(){const e=this;let s=this.activeContent.getAttribute("data-lang");this.activeEditor=t.fromTextArea(this.activeContent,{mode:s,tabSize:this.options.settings.tabSize,lineNumbers:this.options.settings.lineNumbers,lineWrapping:this.options.settings.lineWrapping,readOnly:this.options.settings.readOnly,styleActiveLine:!0,matchBrackets:!0,autoCloseBrackets:!0,autoCloseTags:!0,theme:this.options.editorTheme,scrollbarStyle:"simple"}),this.activeEditor.on("change",()=>{e.activeContent.innerHTML=e.activeEditor.getValue(),e.activeContent.value=e.activeEditor.getValue(),clearTimeout(e.liveTimeout),e.liveTimeout=setTimeout(()=>{e.run()},400)}),this.tabContents=this.wrapper.querySelector(".minibed_tab_contents"),e.heightSetted||i.css(this.tabContents,{height:this.tabContents.offsetHeight+"px"});const r=this.wrapper.querySelector(".CodeMirror-scroll");this.options.settings.scrollLock&&!i.isTouchDevice()&&i.addListener(r,"mousewheel DOMMouseScroll",e=>{let t=e.wheelDelta||e.originalEvent&&e.originalEvent.wheelDelta||-e.detail,i=r.scrollTop+r.getBoundingClientRect().height-r.scrollHeight>=0,s=r.scrollTop<=0;(t<0&&i||t>0&&s)&&e.preventDefault()}),i.addClass(this.loading,"hide"),this.resizer=new i.MBResizable(this.wrapper.querySelector(".CodeMirror"),()=>{e.activeEditor.refresh(),i.css(e.tabContents,{height:e.wrapper.querySelector(".CodeMirror").offsetHeight+"px"})}),this.run()}initEditor(){const e=this;if(i.removeClass(this.loading,"hide"),this.activeEditor&&this.activeEditor.toTextArea(),this.activeContent=this.container.querySelector(".minibed_active_tab"),"yes"===this.activeContent.getAttribute("data-loaded"))return void this.initCodeMirror();const t=[];this.has.js&&this.options.files.js.forEach(e=>{t.push(e)}),this.has.css&&this.options.files.css.forEach(e=>{t.push(e)}),this.has.html&&this.options.files.html.forEach(e=>{t.push(e)}),this.responseCount=0,t.forEach(t=>{i.Request(t,i=>{e.responseCount++;const s=e.wrapper.querySelector('.minibed_tab_content[data-file="'+t+'"]');s.innerHTML=i,s.setAttribute("data-loaded","yes")})}),this.responseCheck=window.setInterval(()=>{e.responseCount===t.length&&(window.clearInterval(e.responseCheck),e.initCodeMirror(),e.liveToggle())},100)}static overrideDefaults(e){return s.Defaults=i.deepExtend({},s.Defaults,e),this}static version(){return VERSION}})});
//# sourceMappingURL=sourcemaps/main.js.map
